[{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/10052","title":"runtime-rs: Fix QEMU backend for runtime-rs","created_at":"2024-07-22T09:11:50Z","state":"closed","merged_at":"2024-07-30T14:00:14Z","approved":true,"comments":["Hi @ananos ,\r\n\r\nIt's still not working: https:\/\/github.com\/kata-containers\/kata-containers\/actions\/runs\/10040696370\/job\/27748841058?pr=10052","Hi @ananos !\r\n\r\nTests are passing, which is pretty good! But I'd like to understand the problem... IIUC it was a [change on runtime-rs\/Makefile](https:\/\/github.com\/kata-containers\/kata-containers\/pull\/8070\/commits\/2d19f3fbd7bf41433c5d98d3bf43be660b5320c5#diff-21ae7c3a772119d42eee8b5e9037558e76af7b5e792398161985ae884ac1c461) that broke qemu-runtime-rs, but looking at your commit here I couldn't identify exactly what config value that changed. Mind to explain?","https:\/\/github.com\/kata-containers\/kata-containers\/pull\/10052\/files#diff-21ae7c3a772119d42eee8b5e9037558e76af7b5e792398161985ae884ac1c461L317 this is the part where it failed for qemu. That's the reason we moved every variable to have a custom, per-hypervisor instance, so that each one hypervisor gets its pre-defined one.","Thanks @ananos , this fix is great news!  However, after spending (too much) time trying to figure out what this change actually does I'm noticing it contains a lot of what looks like spurious change (mostly lines just moved around).  I suggest that you either revert those parts of the change if they are in fact spurious, or separate them into a standalone clean-up commit so as they don't obfuscate the actual functional core of this change.\r\n\r\nAlso, I'm under the impression that the idea of this change is to walk away from general settings valid across hypervisors (e.g. `DEFSTATICRESOURCEMGMT`), potentially customised by hypervisor-specific variants (e.g. `DEFSTATICRESOURCEMGMT_CLH`), and to fully rely on hypervisor-specific settings instead.  If that's the case this should be explicitly stated in the message of a commit that implements this transition (and this transition only).\r\n\r\nThis change fixes breakage caused by PR #8070 after a week's struggle due to the sheer size and impenetrability of #8070.  It would be a shame if the fix was another commit of that same kind. :-)","agree 100%. The sheer fact that the Makefile logic assumes that if more hypervisors are available then the last one would override vars set by the previous ones seems misleading. I will update the commit message to reflect that.\r\n\r\nThe rationale was that this one commit adds per-hypervisor options, trying to address the above issue. But I agree we need to clarify it even more, so I'll split the commit into two: \r\n- first one will add the KERNELPARAMS_FC, decoupling the KERNELPARAMS var for FC\r\n- second one will add the per-hypervisor vars for the resource mgt\/cgroups etc.\r\n\r\nwill update later today and see how that plays out with the tests. I see a couple of required tests failing, not sure why."],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/9964","title":"ci: Cleanup working dir when using self-hosted runners","created_at":"2024-07-04T13:47:02Z","state":"open","merged_at":null,"approved":true,"comments":["@ananos, I'd prefer having that as part of the node configuration, like: https:\/\/docs.github.com\/en\/actions\/hosting-your-own-runners\/managing-self-hosted-runners\/running-scripts-before-or-after-a-job\r\n\r\nAnd I'd like to have those scripts as part of the repo, so anyone setting up a new runner could just copy and paste then to the correct location.","@fidencio This is in the works by https:\/\/github.com\/kata-containers\/kata-containers\/issues\/9934  this is to unblock the CI and once @BbolroC is done with the POC we will create something as you already said for \"ALL\" selfhosted-runners","Please have a look at https:\/\/github.com\/kata-containers\/kata-containers\/issues\/9934#issuecomment-2258094441 if you follow Fabi's suggestion. Thanks!"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/9595","title":"runtime-rs: Add pci_hotplug as a config option","created_at":"2024-05-04T15:43:27Z","state":"open","merged_at":null,"approved":true,"comments":["\/test","For CI failures for s390x, I am working on it and will get it green again. Sorry for the inconvenience. \r\n\r\n---\r\n\r\nUPDATE: all CI jobs for s390x have been passed. ","We should try to keep the discrepancies between dragonball and other VMMs as small as possible. To not introduce too many different configs variables. For qemu\/CLH e.g. we have hot_plug_vfio=\"...\" or cold_plug_vfio=\"...\". ","\/test\r\n","We have introduced #9596 to fix the problem for `CreateVfioDevice(NoResource)` error in Dragonball side.\r\nSo this PR could be close because the problem won't appear after #9596 is merged.","I tend to agree to ditch this PR. My only thought is whether we would be interested in keeping this option in terms of \"faster\" booting maybe?\r\n\r\nOff the top of my head, removing the PCI hotplug initialization part when the user knows it is not needed, could save some time; so it might be useful to some people.. Not sure though -- any thoughts on this?  "],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/7029","title":"runtime-rs: skip ipip network interfaces (iff_noarp)","created_at":"2023-06-03T18:22:22Z","state":"closed","merged_at":null,"approved":false,"comments":["\/test","This qemu-devmapper CI is constantly failing\r\n\r\n```\r\ngzip: stdin: not in gzip format\r\ntar: Child returned status 1\r\ntar: Error is not recoverable: exiting now\r\n[install_cri_containerd.sh:78] ERROR: sudo tar xfz - -C \/usr\/local\/bin\r\n[jenkins_job_build.sh:246] ERROR: ci\/setup.sh\r\nBuild step 'Execute shell' marked build as failure\r\n```\r\n\r\nSeems like a deterministic problem in the CI script.","closing as duplicate of #7021 -- that solutions seems more aligned with the go runtime."],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/7018","title":"runtime-rs: add parameter for propagation of (u)mount events","created_at":"2023-06-01T19:23:27Z","state":"closed","merged_at":"2023-07-14T07:21:41Z","approved":true,"comments":["\/test","\/test","\/test\r\n","\/test","\/retest-devmapper-qemu","\/test","\/test","\/retest-s390x\r\n\/retest-devmapper-qemu\r\n\/retest-crio","\/test","\/test-metrics","\/test-ubuntu-metrics","\/test","\/test","\/retest","\/test"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/6980","title":"runtime-rs: handle copy files when share_fs is not available","created_at":"2023-05-29T10:31:18Z","state":"closed","merged_at":"2023-06-06T10:26:56Z","approved":true,"comments":["Sorry, at the time you opened your PR we were having issues with our CI, which leads to required tests failing without having nothing to do with this PR.\r\n\r\nAS this has been already fixed on  main, we\u00b4d like to ask you to rebase your PR atop of the current `main` branch.\r\n\r\nThanks for the consideration, and sorry for the trouble.","thanks @Tim-0731-Hzt for the comments! really appreciate your prompt response.\r\n\r\nWe weren't sure how to handle the copy request to the agent in share_fs_volume, that's why we did this trampoline thing with manager\/manager_inner and container.rs. It seems that passing the agent as a parameter to the constructor of the share_fs_volume resolves this.\r\n\r\nLet us know if this latest commit addresses your concerns. Thanks again!","https:\/\/github.com\/kata-containers\/kata-containers\/actions\/runs\/5134329580\/jobs\/9238180586?pr=6980#step:10:1914 <- could this be related to this: https:\/\/github.com\/rust-lang\/rust\/issues\/63033 ?\r\n\r\ndo we mind if we move to rust 1.69.0? ","> https:\/\/github.com\/kata-containers\/kata-containers\/actions\/runs\/5134329580\/jobs\/9238180586?pr=6980#step:10:1914 <- could this be related to this: [rust-lang\/rust#63033](https:\/\/github.com\/rust-lang\/rust\/issues\/63033) ?\r\n> \r\n> do we mind if we move to rust 1.69.0?\r\n\r\n\r\n\r\nIt still could work without upgrading to 1.69.0. if you pass the Agent instance as a reference, just like this\r\n```rust\r\npub(crate) async fn new(\r\n      share_fs: &Option<Arc<dyn ShareFs>>,\r\n      m: &oci::Mount,\r\n      cid: &str,\r\n      readonly: bool,\r\n      agent: &dyn Agent,\r\n  )\r\n```\r\nBut I think it's better to use `Arc<dyn Agent>`, as it allows the Agent instance could be shared, and be dropped if no more reference to it. Maybe we should consider moving to 1.69? cc @quanweiZhou @Tim-Zhang @liubin ","\/test","\/test","\/retest-power","@ananos, @Tim-0731-Hzt, not exactly related to this PR, but I'd love to see a `SharedFS: none` option in the runtime-rs, which would explicitly copy the files to the guest in case users only want to use devmapper without having to pay the penalty of still having virtiofsd \/ nydus processes around."],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/4807","title":"stable-2.5 | versions: Update Firecracker version to v1.1.0","created_at":"2022-08-03T11:10:22Z","state":"closed","merged_at":"2022-08-03T15:22:05Z","approved":true,"comments":["\/test","\/test"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/2678","title":"stable-2.2 | virtcontainers: fc: parse vcpuID correctly","created_at":"2021-09-18T08:15:34Z","state":"closed","merged_at":"2021-09-20T16:46:08Z","approved":true,"comments":["\/test-fc","\/test","\/retest-debian","\/retest-fc"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/2593","title":"virtcontainers: fc: parse vcpuID correctly","created_at":"2021-09-07T21:45:32Z","state":"closed","merged_at":"2021-09-13T07:23:53Z","approved":true,"comments":["\/test-fc\r\n","\/test-fc","\/test-fc","\/test-fc","\/test-fc","@ananos the static check failed related to \"Fixes\" even though you have it. Could you either try changing the ordering with depends-on or change the line from  `Fixes: github.com\/#2592` to `Fixes: #2592`? I'm not sure which is the problem. ","> @ananos the static check failed related to \"Fixes\" even though you have it. Could you either try changing the ordering with depends-on or change the line from `Fixes: github.com\/#2592` to `Fixes: #2592`? I'm not sure which is the problem.\r\n\r\njust did -- I'm completely confused about the tests too -- I seem to miss which code is being tested. I'll try once more with the reverse order of Fixes and depends on.","\/test-fc","yea, well, not sure what's going on -- I suspect editing the PR\/force pushing might have a weird cache effect on the CI system if there's a depends-on tag? I'm completely lost...","`fixes #2592` should be enough \r\n\r\n`Depends-on: github.com\/#2332` will not work, it only works when the repo (for example github.com\/test\/#NNN) is different to this","thanks for the info. I updated the commit message & PR comment to reflect this. \r\n\r\nWill test again and see how it goes.","\/test-fc","\/test-fc\r\n","\/test-fc","@ananos, based on @devimc comment I think we can drop the \"Depends-on; \" tag, retest ... and if we get a green run on this one, we ask Samuel to rebase.","sure, I wanted to test one last thing so I'll force push after this test finishes and I'll remove the depends-on tag. According to the [build logs](http:\/\/jenkins.katacontainers.io\/job\/kata-containers-2.0-firecracker-ubuntu-PR\/1096\/consoleFull), it seems that the system only test the depends-on tag\/PR and not both.\r\n\r\n```\r\n12:22:49 This PR depends on repository: github.com\/kata-containers\/kata-containers and pull request: 2332\r\n12:22:49 \/tmp\/jenkins\/workspace\/kata-containers-2.0-firecracker-ubuntu-PR\/go\/src\/github.com\/kata-containers\/kata-containers \/tmp\/jenkins\/workspace\/kata-containers-2.0-firecracker-ubuntu-PR\/go\/src\/github.com\/kata-containers\/kata-containers \/tmp\/jenkins\/workspace\/kata-containers-2.0-firecracker-ubuntu-PR\/go\/src\/github.com\/kata-containers\/kata-containers\r\n12:22:49 Fetching pull request: 2332 for repository: github.com\/kata-containers\/kata-containers\r\n12:22:49 From https:\/\/github.com\/kata-containers\/kata-containers\r\n12:22:49  * [new ref]           refs\/pull\/2332\/head -> p2332\r\n12:22:49 Switched to branch 'p2332'\r\n12:22:49 Auto-merging src\/runtime\/cli\/kata-check.go\r\n12:22:49 Merge made by the 'recursive' strategy.\r\n[snipped]\r\n12:22:49 a5aea8bc Merge remote-tracking branch 'origin\/main' into p2332\r\n12:22:49 230eae3f Merge pull request #2417 from jcvenegas\/docker-build-fixes\r\n12:22:49 11652136 actions: test make kata-tarball\r\n12:22:49 626d659f actions: kata-deploy on PRs and use makefile\r\n12:22:49 78d99f51 kata-deploy: Make verbose single builds\r\n12:22:49 59486b85 kata-deploy: Add tarball suffix to makefile targets\r\n12:22:49 96e1246b makefile: Include kata-deploy targets\r\n12:22:49 c1af5d30 runtime: Vendoring update\r\n12:22:49 5db3b8de docs: Host cgroups documentation update\r\n12:22:49 fa4ad1be virtcontainers: Convert to the new cgroups package API\r\n12:22:49 9aa732b3 virtcontainers: cgroups: Add a containerd API based cgroups package\r\n12:22:49 165f3440 virtcontainers: container: Do not create and manage container host cgroups\r\n12:22:49 310bb991 virtcontainers: sandbox: Host cgroups partitioning\r\n12:22:49 18af16c8 virtcontainers: Unconditionally create the sandbox cgroup manager\r\n12:22:49 \/tmp\/jenkins\/workspace\/kata-containers-2.0-firecracker-ubuntu-PR\/go\/src\/github.com\/kata-containers\/kata-containers \/tmp\/jenkins\/workspace\/kata-containers-2.0-firecracker-ubuntu-PR\/go\/src\/github.com\/kata-containers\/kata-containers\r\n```","\/test-fc\r\n","re-triggering as the failure was not related to the patch:\r\n\r\n```\r\n13:02:23 W0910 10:02:23.447892   30361 unmount_linux.go:48] [reset] Failed to unmount mounted directory in \/var\/lib\/kubelet\/: \/var\/lib\/kubelet\/plugins\/kubernetes.io~local-volume\/volumeDevices\/block-loop-pv\/7d6f28f6-2caa-450e-b5bc-2d0909cfa468\r\n```","\/test-fc","\/retest-fc","\/test-fc","The failure was, again, not related.","@ananos, CI is green, I'm running a \/test in order to get this merged, then @sameo can rebase his PR after that.","\/test-clh-k8s-containerd","\/retest-ubuntu-metrics","\/retest-clh-k8s-containerd","@ananos, by the way, this one deserves a backport if you happen to have the time."],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/2413","title":"stable-2.1 | virtcontainers: fc: properly remove jailed block device","created_at":"2021-08-09T15:12:40Z","state":"closed","merged_at":"2021-08-10T12:42:24Z","approved":true,"comments":["\/test","\/retest-debian","\/retest-arm"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/2388","title":"virtcontainers: fc: properly remove jailed block device","created_at":"2021-08-04T16:28:44Z","state":"closed","merged_at":"2021-08-09T22:17:18Z","approved":true,"comments":["\/test","\/test","Let me just add the `do-not-merge` label to this PR for now, as I'd like to take this opportunity to introduce tests in our CI to run firecracker with jailer support.\r\n\r\nI've synced with @ananos and we will go through this on Friday (Europe) morning.","While taking a look at http:\/\/jenkins.katacontainers.io\/job\/kata-containers-2.0-firecracker-ubuntu-PR\/ I've just noticed that it's been using the `master` branch as its entrypoint.\r\n```\r\n#!\/bin\/bash\r\n\r\nset -e\r\n\r\nexport DEBUG=true\r\nexport KATA_HYPERVISOR=\"firecracker\"\r\nexport CI=\"true\"\r\nexport CI_JOB=\"FIRECRACKER\"\r\nexport SHIMV2_TEST=\"true\"\r\n\r\ncurl -OL https:\/\/raw.githubusercontent.com\/kata-containers\/tests\/master\/.ci\/ci_entry_point.sh\r\nbash -x ci_entry_point.sh \"${GIT_URL}\"\r\n```\r\n\r\nI've switched that to `main` and I am going to retrigger the tests here.","\/test-fc","\/retest","\/test-fc-jailer","\/retest-ubuntu\r\n\/retest-centos","\/retest-arm\r\n\/retest-s390x","\/retest-s390x","Now that the new CI job has been added, let's ensure it works here.\r\n\/test-fc-jailer","\/test-fc-jailer","\/test-fc-jailer","\/test-fc-jailer","\/test-arm\r\n\/test-fc-jailer\r\n","\/test-fc-jailer"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/8070","title":"runtime-rs: firecracker hypervisor backend ","created_at":"2023-09-26T19:36:09Z","state":"closed","merged_at":"2024-07-03T19:29:30Z","approved":true,"comments":["Can one of the admins verify this patch?","\/test","\/test","\/test","\/test","\/test\r\n","@Pyrromanis - please could you ping me on this PR once you've updated so I can re-review. Can't wait to see this land! ;)","\/test","\/test\r\n","\/test","Hi @Pyrromanis \r\n\r\nThanks for the FC supporting effort, most of the patch LGTM except some small comments.\r\n","> Hi @Pyrromanis\r\n> \r\n> Thanks for the FC supporting effort, most of the patch LGTM except some small comments.\r\n\r\nthanks @lifupan for the comments -- all look reasonable and prob. easy to address. We'll report back once we get to it! \r\n"],"user_login":"Pyrromanis","user_url":"https:\/\/github.com\/Pyrromanis"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/4735","title":"versions: Update Firecracker version to v1.1.0","created_at":"2022-07-25T16:27:56Z","state":"closed","merged_at":"2022-07-26T23:20:33Z","approved":true,"comments":["\/test","I'd like to have this one bumped as part of the stable branch as well.","\/test-fc","\/test","\/test","\/retest-arm","\/retest-ubuntu","\/test-devmapper-qemu"],"user_login":"gntouts","user_url":"https:\/\/github.com\/gntouts"},{"url":"https:\/\/github.com\/kata-containers\/kata-containers\/pull\/4012","title":"docs: Add a firecracker installation guide","created_at":"2022-03-31T12:53:34Z","state":"closed","merged_at":"2022-04-06T10:59:56Z","approved":true,"comments":["\/test","Only just seen this - nice - thanks @gntouts! ;)"],"user_login":"gntouts","user_url":"https:\/\/github.com\/gntouts"},{"url":"https:\/\/github.com\/unikraft\/unikraft\/pull\/1287","title":"drivers\/ukintctrl: Update GICv2 compatible list","created_at":"2024-01-29T10:25:30Z","state":"closed","merged_at":"2024-02-05T11:03:44Z","approved":true,"comments":["Approved-by: Michalis Pappas <michalis@unikraft.io>"],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/containerd\/containerd\/pull\/7402","title":"Add ext2 fs support to devmapper snapshotter","created_at":"2022-09-19T09:34:19Z","state":"closed","merged_at":"2022-09-19T17:37:08Z","approved":true,"comments":["Hi @ananos. Thanks for your PR.\n\nI'm waiting for a [containerd](https:\/\/github.com\/orgs\/containerd\/people) member to verify that this patch is reasonable to test. If it is, they should reply with `\/ok-to-test` on its own line. Until that is done, I will not automatically test new commits in this PR, but the usual testing commands by org members will still work. Regular contributors should [join the org](https:\/\/github.com\/containerd\/project\/blob\/main\/MAINTAINERS) to skip this step.\n\nOnce the patch is verified, the new status will be reflected by the `ok-to-test` label.\n\nI understand the commands that are listed [here](https:\/\/go.k8s.io\/bot-commands?repo=containerd%2Fcontainerd).\n\n<details>\n\nInstructions for interacting with me using PR comments are available [here](https:\/\/git.k8s.io\/community\/contributors\/guide\/pull-requests.md).  If you have questions or suggestions related to my behavior, please file an issue against the [kubernetes\/test-infra](https:\/\/github.com\/kubernetes\/test-infra\/issues\/new?title=Prow%20issue:) repository.\n<\/details>\n","thanks for your prompt response!\r\n\r\nwe run NetBSD-based unikernels on Linux, so no need. The rationale is to be able to use the DM block device directly from the unikernel."],"user_login":"ananos","user_url":"https:\/\/github.com\/ananos"},{"url":"https:\/\/github.com\/sigstore\/rekor-monitor\/pull\/245","title":"replaced time.Sleep in main loop with ticker","created_at":"2023-07-11T13:22:09Z","state":"closed","merged_at":"2023-07-13T16:37:00Z","approved":true,"comments":["## [Codecov](https:\/\/app.codecov.io\/gh\/sigstore\/rekor-monitor\/pull\/245?src=pr&el=h1&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=sigstore) Report\n> Merging [#245](https:\/\/app.codecov.io\/gh\/sigstore\/rekor-monitor\/pull\/245?src=pr&el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=sigstore) (4852e86) into [main](https:\/\/app.codecov.io\/gh\/sigstore\/rekor-monitor\/commit\/8c9d76bcaef4d702874f45139684e6c6bc1a39bd?el=desc&utm_medium=referral&utm_source=github&utm_content=comment&utm_campaign=pr+comments&utm_term=sigstore) (8c9d76b) will **not change** coverage.\n> The diff coverage is `n\/a`.\n\n```diff\n@@           Coverage Diff           @@\n##             main     #245   +\/-   ##\n=======================================\n  Coverage   58.87%   58.87%           \n=======================================\n  Files           4        4           \n  Lines         231      231           \n=======================================\n  Hits          136      136           \n  Misses         70       70           \n  Partials       25       25           \n```\n\n\n\n","The linter failed because unfortunately we currently have some bad design in the main loop where we call `log.Fatal` in a lot of places. We need to do some refactoring at some point, but for now, we can explicitly call `ticker.Stop()` before calling `log.Fatal`, or try to do some refactoring.","Do you have any suggestions for refactoring? My initial thoughts would be to encapsulate a part of the main function within a separate function. This wrapper function should return an error containing the precise message that would be printed by log.Fatalf(). That way, the `defer ticker.Stop()` statement will run, while still allowing the use of log.Fatalf() in the main function to keep the user-facing messages unchanged.","That sounds great. Over time, I'd like to split up the main loop into smaller functions, but for now, wrapping it would be good.","I wrapped the loop in a separate function and modified the ticker loop to get an immediate fisrt tick. Let me know what you think. "],"user_login":"gntouts","user_url":"https:\/\/github.com\/gntouts"}]